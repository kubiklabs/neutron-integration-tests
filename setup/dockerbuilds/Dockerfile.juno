# syntax=docker/dockerfile:1

FROM golang:1.18-alpine AS builderj
RUN apk upgrade -U -a
WORKDIR /src/appj/
COPY --from=appj go.mod go.sum* ./
RUN go mod download
COPY --from=appj . .
ENV PACKAGES curl make git libc-dev bash gcc linux-headers eudev-dev python3
RUN apk add --no-cache $PACKAGES
RUN CGO_ENABLED=0 make install

FROM alpine:latest
WORKDIR /opt/juno/
COPY --from=setupj . setupj/
ARG BINARY
COPY --from=builderj /go/bin/${BINARY:-junod} /usr/local/bin/

EXPOSE 26656 26657 1317 9090
USER 0

CMD sh /opt/juno/setupj/init.sh && \
  sh /opt/juno/setupj/init-junod.sh && \
  sh /opt/juno/setupj/start.sh
